<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insurance IT Poker Multiplayer</title>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: linear-gradient(135deg,#0f172a,#1e293b);
  color: white;
  text-align: center;
}

.hidden { display: none; }

input, button {
  padding: 12px;
  margin: 6px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}

button { background:#22d3ee; cursor:pointer; }

.table {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:14px;
  margin:40px;
}

.card {
  width:90px;
  height:130px;
  background:#38bdf8;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
  animation:float 3s infinite ease-in-out;
}

.card:hover { transform:scale(1.1); }

.selected { background:#22c55e; color:white; }

.players { margin-top:20px; }

@keyframes float {
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-8px)}
}
</style>
</head>

<body>

<h1>üÉè Insurance IT Poker</h1>

<div id="join">
  <input id="name" placeholder="Your name">
  <input id="room" placeholder="Room code">
  <button onclick="join()">Join</button>
</div>

<div id="game" class="hidden">
  <h3>Room: <span id="roomLabel"></span></h3>

  <div class="table" id="cards"></div>

  <button onclick="reveal()">Show Votes</button>
  <button onclick="clearVotes()">Clear</button>

  <h3 id="avg"></h3>
  <div class="players" id="players"></div>
</div>

<script>
// üî• replace with your firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCuxdwsW_kaDwiJk8W7i-5WdpwRVL5_cko",
    authDomain: "pointing-poker-8ef91.firebaseapp.com",
    projectId: "pointing-poker-8ef91",
    databaseURL: "https://pointing-poker-8ef91-default-rtdb.europe-west1.firebasedatabase.app/",
    storageBucket: "pointing-poker-8ef91.firebasestorage.app",
    messagingSenderId: "207111296808",
    appId: "1:207111296808:web:4e70f8f832a0e3fd97621d",
    measurementId: "G-S0WJX04G6P"
  };

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const values = ["1","2","3","5","8","13","21","?"];

let room = "";
let playerId = Math.random().toString(36).slice(2);
let revealState = false;

// ‚úÖ read room from URL
const params = new URLSearchParams(window.location.search);
const urlRoom = params.get("room");
if (urlRoom) document.getElementById("room").value = urlRoom;

function join() {
  const name = document.getElementById("name").value.trim();
  room = document.getElementById("room").value.trim();

  if(!name || !room) return alert("Enter name + room");

  document.getElementById("join").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("roomLabel").textContent = room;

  // update URL to shareable link
  const shareURL = `${window.location.origin}${window.location.pathname}?room=${room}`;
  window.history.replaceState({}, "", shareURL);

  db.ref(`rooms/${room}/players/${playerId}`).set({name,vote:null});

  renderCards();
  listen();
}

function copyLink(){
  const link = window.location.href;
  navigator.clipboard.writeText(link);
  alert("Link copied!");
}

function renderCards(){
  const table = document.getElementById("cards");
  table.innerHTML="";
  values.forEach(v=>{
    const c=document.createElement("div");
    c.className="card";
    c.textContent=v;
    c.onclick=()=>{
      db.ref(`rooms/${room}/players/${playerId}/vote`).set(v);
      document.querySelectorAll(".card").forEach(x=>x.classList.remove("selected"));
      c.classList.add("selected");
    };
    table.appendChild(c);
  });
}

function listen(){
  db.ref(`rooms/${room}`).on("value",snap=>{
    const data=snap.val();
    if(!data) return;

    revealState=data.reveal||false;

    const players=data.players||{};
    const container=document.getElementById("players");
    container.innerHTML="";

    let nums=[];

    Object.values(players).forEach(p=>{
      const div=document.createElement("div");
      let vote="üÇ†";
      if(!p.vote) vote="‚Ä¶";
      if(revealState && p.vote) vote=p.vote;

      if(!isNaN(p.vote)) nums.push(Number(p.vote));

      div.textContent=`${p.name}: ${vote}`;
      container.appendChild(div);
    });

    if(revealState && nums.length){
      const avg=(nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(1);
      document.getElementById("avg").textContent=`Average: ${avg}`;
      confetti();
    } else {
      document.getElementById("avg").textContent="";
    }
  });
}

function reveal(){
  db.ref(`rooms/${room}/reveal`).set(true);
}

function clearVotes(){
  db.ref(`rooms/${room}/players`).once("value",snap=>{
    snap.forEach(p=>p.ref.child("vote").set(null));
  });
  db.ref(`rooms/${room}/reveal`).set(false);
}

function confetti(){
  for(let i=0;i<40;i++){
    const d=document.createElement("div");
    d.textContent="üéâ";
    d.style.position="fixed";
    d.style.left=Math.random()*100+"vw";
    d.style.top="-20px";
    document.body.appendChild(d);
    d.animate([{transform:"translateY(0)"},{transform:"translateY(100vh)"}],
              {duration:2000});
    setTimeout(()=>d.remove(),2000);
  }
}
</script>

</body>
</html>
